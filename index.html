<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Suivi d'heures - Travail de nuit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f9; }
    header { background:#222; color:#fff; padding:1rem; text-align:center; }
    .container { max-width:900px; margin:1rem auto; background:#fff; padding:1rem; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    label { display:block; margin-top:1rem; font-size:14px; }
    input, button, select { width:100%; padding:0.6rem; margin-top:0.5rem; border-radius:6px; border:1px solid #ccc; font-size:14px; }
    button { background:#0ea5e9; color:#fff; border:none; cursor:pointer; }
    button:hover { opacity:0.9; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:14px; }
    th, td { border:1px solid #ddd; padding:0.5rem; text-align:center; }
    th { background:#f0f0f0; }
    .bilan { margin-top:1.5rem; padding:1rem; background:#fafafa; border:1px solid #ddd; border-radius:6px; }
    .month-controls { margin-top:1rem; display:flex; gap:0.5rem; flex-wrap:wrap; }
    .months-history { margin-top:1rem; }
    .action-btn { padding:0.3rem 0.6rem; font-size:12px; border-radius:4px; border:none; cursor:pointer; }
    .edit-btn { background:#facc15; color:#000; }
    .delete-btn { background:#ef4444; color:#fff; }
    @media (max-width:600px) {
      table, thead, tbody, th, td, tr { display:block; }
      th { display:none; }
      td { border:none; border-bottom:1px solid #eee; padding:0.5rem; text-align:left; }
      td:before { font-weight:bold; display:block; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Suivi d'heures - Travail de nuit</h1>
  </header>
  <div class="container">
    <h2>Ajouter / Modifier une prestation</h2>
    <form id="timeForm">
      <input type="hidden" id="editIndex">
      <label for="date">Date (soir de d√©but) :</label>
      <input type="date" id="date" required>
      <label for="start">Heure de d√©but :</label>
      <input type="time" id="start" required>
      <label for="end">Heure de fin (lendemain) :</label>
      <input type="time" id="end" required>
      <button type="submit">Enregistrer</button>
    </form>

    <h2>Historique du mois en cours</h2>
    <table id="recordsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>D√©but</th>
          <th>Fin</th>
          <th>Dur√©e</th>
          <th>Salaire (‚Ç¨)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="bilan">
      <h3>Bilan du mois en cours</h3>
      <p>Total heures : <span id="totalHours">0h 00m</span></p>
      <p>Total salaire : <span id="totalSalary">0</span> ‚Ç¨</p>
      <div class="month-controls">
        <button id="closeMonth">Cl√¥turer le mois</button>
        <button id="newMonth">Cr√©er un nouveau mois</button>
      </div>
    </div>

    <div class="months-history">
      <h3>Historique des mois cl√¥tur√©s</h3>
      <ul id="monthsList"></ul>
    </div>
  </div>

  <script>
    const form = document.getElementById('timeForm');
    const tbody = document.querySelector('#recordsTable tbody');
    const totalHoursEl = document.getElementById('totalHours');
    const totalSalaryEl = document.getElementById('totalSalary');
    const monthsList = document.getElementById('monthsList');
    const rate = 12; // ‚Ç¨/h

    let currentMonth = localStorage.getItem('currentMonth') || new Date().toISOString().slice(0,7);
    let records = JSON.parse(localStorage.getItem('records_'+currentMonth) || '[]');
    let closedMonths = JSON.parse(localStorage.getItem('closedMonths') || '[]');

    function saveData(){
      localStorage.setItem('records_'+currentMonth, JSON.stringify(records));
      localStorage.setItem('currentMonth', currentMonth);
      localStorage.setItem('closedMonths', JSON.stringify(closedMonths));
    }

    function formatDuration(hours){
      const h = Math.floor(hours);
      const m = Math.round((hours - h) * 60);
      return `${h}h ${String(m).padStart(2,'0')}m`;
    }

    function renderTable(){
      tbody.innerHTML = '';
      let total = 0;
      records.forEach((r,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.date}</td><td>${r.start}</td><td>${r.end}</td><td>${formatDuration(r.hours)}</td><td>${r.salary}</td>
        <td>
          <button class="action-btn edit-btn" onclick="editRecord(${i})">‚úèÔ∏è</button>
          <button class="action-btn delete-btn" onclick="deleteRecord(${i})">üóëÔ∏è</button>
        </td>`;
        tbody.appendChild(tr);
        total += r.hours;
      });
      totalHoursEl.textContent = formatDuration(total);
      totalSalaryEl.textContent = (total * rate).toFixed(2);
    }

    function renderMonths(){
      monthsList.innerHTML = '';
      closedMonths.forEach(m => {
        const li = document.createElement('li');
        li.textContent = `${m.month} - ${formatDuration(m.totalHours)} - ${m.totalSalary} ‚Ç¨`;
        monthsList.appendChild(li);
      });
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const editIndex = document.getElementById('editIndex').value;

      const startDate = new Date(date + 'T' + start);
      let endDate = new Date(date + 'T' + end);
      if (endDate <= startDate) endDate.setDate(endDate.getDate() + 1);
      const diff = (endDate - startDate)/1000/3600;
      if (diff <= 0) { alert('Heures invalides'); return; }
      const salary = (diff * rate).toFixed(2);

      if(editIndex){
        records[editIndex] = {date, start, end, hours: diff, salary};
        document.getElementById('editIndex').value = '';
      } else {
        records.push({date, start, end, hours: diff, salary});
      }

      saveData();
      renderTable();
      form.reset();
    });

    function editRecord(index){
      const r = records[index];
      document.getElementById('date').value = r.date;
      document.getElementById('start').value = r.start;
      document.getElementById('end').value = r.end;
      document.getElementById('editIndex').value = index;
    }

    function deleteRecord(index){
      if(confirm('Supprimer cette entr√©e ?')){
        records.splice(index,1);
        saveData();
        renderTable();
      }
    }

    document.getElementById('closeMonth').addEventListener('click', ()=>{
      const total = records.reduce((s,r)=>s+r.hours,0);
      const monthData = {
        month: currentMonth,
        totalHours: total,
        totalSalary: (total * rate).toFixed(2)
      };
      closedMonths.push(monthData);
      records = [];
      saveData();
      renderTable();
      renderMonths();
      alert('Mois cl√¥tur√© !');
    });

    document.getElementById('newMonth').addEventListener('click', ()=>{
      const newMonth = prompt('Entrer le mois au format AAAA-MM:', new Date().toISOString().slice(0,7));
      if(newMonth){
        currentMonth = newMonth;
        records = [];
        saveData();
        renderTable();
      }
    });

    renderTable();
    renderMonths();

    // Expose to window for inline buttons
    window.editRecord = editRecord;
    window.deleteRecord = deleteRecord;
  </script>
</body>
</html>
